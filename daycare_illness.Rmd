---
title: "Illness Burden in Daycare Attendees"
date: "`r format(Sys.time(),'%B, %d, %Y')`"
output:
  rmdformats::readthedown:
    highlight: kate
    code_folding: hide
    fig_caption: true
bibliography: boca_library.bib
---

```{r knitr_init, echo = FALSE, cache = FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = TRUE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
opts_knit$set(width = 85)
```

Note: the reader may notice that I sometimes write code, comment it out, then save the output and read it in afterward. This is to save compilation time when knitting this markdown document.

# Introduction

Human bocavirus (HBoV-1), a DNA virus first identified in 2005 [@allander_cloning_2005], has been frequently detected in young children experiencing acute respiratory tract illness. HBoV-1 has been detected in up to 18% of samples from children with respiratory illness [@jartti_human_2012]. Over 85% of children in the United States have antibodies to this virus by 4 years of age [@kahn_seroepidemiology_2008], yet HBoV-1 is rarely detected in adults [@jartti_human_2012]. Furthermore, HBoV-1 is often detected in children without evidence of disease and is often identified alongside with other respiratory viruses associated with acute illness [@jartti_human_2012, @martin_clinical_2008, @fry_human_2007, @allander_human_2007, @christensen_human_2010]. Thus, retrospective or cross-sectional analyses designed to make an inference on disease progression, incidence and persistence are problematic. The purpose of this analysis is in identifying trends regarding persistence and latency of human bocavirus 1 in a pediatric cohort.

## Data Source

Data for the current study comes from previously reported prospective studies of human herpesvirus 6 (HHV-6) natural history and human bocavirus-1 shedding events from a group of infants [@zerr_population-based_2005], [@martin_human_2015]. Incidence of HHV-6 has been reported between 64-83% in the United States and in some studies up to 90% prevalence has been reported [@braun_human_1997]. For this reason, the entire cohort of children carried HHV-6 at one point in the 2-year study period.

## Study Population

Inclusion criteria for enrollment included pregnancy of the mother, receipt of care at a Seattle area-based obstetrical practice, and provision of informed consent prior to participation. Children were then followed from birth for up to two years between April 1997 and August 2003. No further exclusion criteria were applied within the birth cohort.

## Clinical Data Collection

Demographic data were collected from the mother at enrollment through administered surveys. Symptom data were collected using a daily diary recorded by the mother and/or father. Symptoms included: fever (temperature >38.0&deg; C), roseolla cough, runny-nose, vomiting, diarrhea, rash, fussiness above the baseline level for the child, seizure, and physician visit for illness. Data was further collected on breast-feeding, breast-feeding duration, group child-care, daycare attendance and duration and playgroup attendance.

## Methods 

Infection episodes were defined as at least two weeks of RT-PCR positive HBoV-1 infection for entry and exit with no more than 1 interrim negative specimen within the episode. The first episode was termed primary with all others defined as secondary, tertiary, quaternary, and quinary. For purposes of analyses all secondary and subsequent infection episodes were categorized as 'secondary'.

# Libraries and Preferences

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(magrittr)
library(tableone)
library(ggthemes)
```

Color Preferences

```{r}
set1 <- RColorBrewer::brewer.pal(9, "Set1")
```

# Load Data

```{r, warning = FALSE}
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata")
setwd("Rdata/")

files <- list.files(pattern = "*.rds")
file_names <- gsub(".rds", "", files)
file_names <- gsub("_", ".", file_names)
for (i in 1:length(files)) {
  assign(file_names[i], readRDS(files[i]))
}
rm(files, file_names)
```

```{r, eval = TRUE, echo = FALSE}
# true minimal theme
theme_trueMinimal <- function(base_size = 16, base_family = "") {
    theme_bw(base_size = base_size, base_family = base_family) %+replace% 
        theme(axis.ticks = element_blank(), 
              legend.background = element_blank(), 
              legend.key = element_blank(), 
              panel.background = element_blank(), 
              strip.background = element_blank(), 
              panel.border = element_blank(),
              panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              plot.background = element_blank(), 
              axis.line = element_line(), 
              axis.line.y = element_blank(),
              complete = TRUE)
}
```

# Data processing

```{r}
ids <- data.frame(id = unique(main$id))
to_factor <- c("pos", "female", "race", "race_text", "family.income",
               "siblings", "breast_fed", "day_care", "seizure_hx", 
               "pg_tmp")
floor_week <- function(x) lubridate::floor_date(x, unit = "week")
to_week <- c("maternal.dob", "infant.dob", "stopdate",
             "daycare.start", "daycare.end",
             "play.start", "play.end", "last.fu.visit")

demo <- main %>%
  mutate(
    id = as.character(id),
    race_text = as.character(race_text),
    race_text = ifelse(race_text %in% c("white,asian", "nat amer", "hispanic"),
                       "other", race_text),
    race_text = ifelse(race_text == "", "unknown", race_text),
    race = ifelse(race %in% c(3, 4, 5), 3, race),
    last.fu.visit = as.Date(last.f.u.visit, "%d-%b-%y"),
    pg_tmp = ifelse(play.group == "Y", 1, 0),
    pg_tmp = ifelse(play.group == "unknown", NA, pg_tmp),
    mage.at.birth = as.numeric(difftime(infant.dob, maternal.dob, 
                                        units = "days") / 365),
    dc_dur = as.numeric(difftime(daycare.end, daycare.start,
                                 units = "weeks")),
    pg_dur = as.numeric(difftime(play.end, play.start,
                                 units = "weeks"))
    ) %>%
  mutate_at(vars(to_factor), funs(factor)) %>%
  mutate_at(vars(to_week), funs(floor_week)) %>%
  select(id, pos, female, mage.at.birth, maternal.dob:until.when,
         daycare.start, daycare.end, dc_dur,
         play.start, play.end, pg_tmp, pg_dur,
         bf_duration, siblings:seizure_hx, last.fu.visit) %>%
  rename(
    hbov.pos = pos,
    play.group = pg_tmp
    )
```

Setup time-dependent covariates: daycare and playgroup attendance. Age should probably be adjusted for too - maybe piecewise on age?

```{r}
dc_dates <- demo %>%
  mutate(daycare.end = if_else(is.na(daycare.end), stopdate, daycare.end)) %>%
  select(id, daycare.start, daycare.end) %>%
  filter(!is.na(daycare.start))

pg_dates <- demo %>%
  select(id, play.start, play.end) %>%
  filter(!is.na(play.start))
```

Define ARI here as at least two of fever, cough, runnynose

```{r, warning = FALSE}
dummy <- function(x) {
  x <- ifelse(x != 0, 1, 0)
  x
}

diary <- diaries %>%
  right_join(ids, by = "id") %>%
  filter(!is.na(diary)) %>%
  mutate(week = floor_week(date)) %>%
  select(id, week, fever, cough, runnynose) %>%
  group_by(id, week) %>%
  summarise_at(vars(fever, cough, runnynose), funs(sum(., na.rm = TRUE))) %>%
  ungroup() %>%
  mutate_at(vars(fever, cough, runnynose), funs(dummy)) %>%
  mutate(
    sum = rowSums(.[3:5]),
    ill = ifelse(sum >= 2, 1, 0)
  ) %>%
  group_by(id) %>%
  mutate(stdy_wk = row_number()) %>%
  ungroup() %>%
  # add daycare dates
  full_join(dc_dates, by = "id") %>%
  # add playgroup dates
  full_join(pg_dates, by = "id") %>%
  mutate(
    daycare = ifelse(week >= daycare.start & week <= daycare.end, 1, 0),
    daycare = ifelse(is.na(daycare), 0, daycare),
    playgrp = ifelse(week >= play.start & week <= play.end, 1, 0),
    playgrp = ifelse(is.na(playgrp), 0, playgrp)
  ) %>%
  select(-daycare.start, -daycare.end, -play.start, -play.end)
```

## Ol' Classic Table 1

Assess normality of continuous data:

```{r}
nonnormal <- c("total.number.of.family", 
               "number.of.family.18.yrs",
               "dc_dur")
par(mfrow = c(1, length(nonnormal)))
for(i in 1:length(nonnormal)) {
  plot(density(demo[, nonnormal[i]], na.rm = TRUE),
       main = nonnormal[i])
}
```

```{r}
# dput(colnames(demo))
vars <- c("hbov.pos", "female", "mage.at.birth", "race_text", 
          "total.number.of.family", "number.of.family.18.yrs", 
          "family.income", "siblings", "breast_fed", "bf_duration", 
          "day_care", "dc_dur", "play.group", "pg_dur", "seizure_hx")
tbl1 <- CreateTableOne(vars = vars, data = demo)
print(tbl1, nonnormal = nonnormal)
rm(tbl1)
```

Summarize panel data

```{r}
sapply(diary[, c(3:7, 9, 10)], table)
```

Visualize illness chains

```{r, fig.width = 8, fig.height = 4}
some_ids <- sample(unique(diary$id), 8, replace = FALSE)
diary %>%
  filter(id %in% some_ids) %>%
  select(id, stdy_wk, ill) %>%
  ggplot(aes(x = stdy_wk, y = ill)) %>%
  add(geom_point()) %>%
  add(geom_line()) %>%
  add(facet_wrap(~id, nrow = 2)) %>%
  add(scale_y_continuous(breaks = c(0, 1))) %>%
  add(theme_trueMinimal(16)) %>%
  add(labs(
    x = "\nStudy Week",
    y = "Recorded Illness\n"
  ))
```

```{r, fig.width = 6, fig.height = 4}
some_ids <- sample(unique(diary$id), 4, replace = FALSE)
diary %>%
  filter(id %in% some_ids) %>%
  select(id, stdy_wk, ill) %>%
  ggplot(aes(x = stdy_wk, y = ill, color = id)) %>%
  add(geom_point()) %>%
  add(geom_line()) %>%
  add(scale_y_continuous(breaks = c(0, 1))) %>%
  add(theme_trueMinimal(16)) %>%
  add(labs(
    x = "\nStudy Week",
    y = "Recorded Illness\n"
  ))
```

Illness episodes/recorded are randomly distributed throughout the studied life history of these infants, as evidenced by the above vignettes.

Daycare attendance may modify illness frequency, the timeliness of daycare attendance of the infant lifecourse is more or less random:

```{r}
some_ids <- sample(demo$id[demo$day_care == 1], 8)

dc_times <- diary %>%
  filter(id %in% some_ids & daycare == 1) %>%
  group_by(id) %>%
  mutate(first = row_number() == 1, last = row_number() == n()) %>%
  filter(first | last) %>%
  select(id, stdy_wk) %>%
  mutate(
    timevar = row_number(),
    timevar = ifelse(timevar == 1, "xmin", "xmax")
    ) %>%
  spread(key = timevar, value = stdy_wk)

diary %>%
  filter(id %in% some_ids) %>%
  ggplot(aes(x = stdy_wk, y = ill)) %>%
  add(geom_point()) %>%
  add(geom_line()) %>%
  add(geom_rect(data = dc_times, 
                aes(xmin = xmin, 
                    xmax = xmax,
                    ymin = -Inf, 
                    ymax = Inf),
                alpha = 0.3,
                inherit.aes = FALSE)) %>%
  add(facet_wrap(~id, nrow = 2)) %>%
  add(theme_trueMinimal()) %>%
  add(scale_y_continuous(breaks = c(0, 1))) %>%
  add(labs(
    x = "\nStudy Week",
    y = "ARI episodes\n",
    caption = "Period in grey denotes daycare attendance"
  ))
```

```{r, fig.width = 8, fig.height = 10}
times <- diary %>%
  filter(daycare == 1) %>%
  group_by(id) %>%
  mutate(first = row_number() == 1, last = row_number() == n()) %>%
  filter(first | last) %>%
  select(id, stdy_wk) %>%
  mutate(
    timevar = row_number(),
    timevar = ifelse(timevar == 1, "xmin", "xmax")
    ) %>%
  spread(key = timevar, value = stdy_wk)

points <- diary %>%
  right_join(times, by = "id") %>%
  filter(ill == 1) %>%
  select(id, stdy_wk)

lines <- diary %>%
  group_by(id) %>%
  arrange(stdy_wk) %>%
  filter(row_number() == n()) %>%
  select(id, stdy_wk) %>%
  ungroup() %>%
  right_join(distinct(points, id), by = "id")

p <- points %>%
  ggplot(aes(x = id, y = stdy_wk)) %>%
  add(coord_flip()) %>%
  add(geom_point(size = 1)) %>%
  add(geom_linerange(data = lines, 
                     aes(x = id, ymin = 0, ymax = stdy_wk),
                     size = 0.1)) %>%
  add(geom_linerange(data = times,
                     aes(x = id, ymin = xmin, ymax = xmax),
                     size = 2,
                     alpha = 0.5,
                     inherit.aes = FALSE)) %>%
  add(theme_trueMinimal()) %>%
  add(theme(axis.text.y = element_text(size = 7))) %>%
  add(labs(
    y = "Infant Age, Weeks",
    x = "ID"
    ))
p
```

The above plot describes ARI recurrence by infant. Each point is an ARI episode ($\ge$ 2 of cough, runny nose, sore throat, etc.), and each thick grey line is the duration of daycare attendance as recorded in the diary.

```{r, echo = FALSE, eval = FALSE}
# ggsave("daycare_experience.tiff", p, device = "tiff",
#        path = "plots/",
#        width = 8, height = 10, units = "in", dpi = 600)
```

# Modelling

## Markov Approach

Identify illness episodes: negative (1), detection (2), first observation (firstobs).

```{r}
states <- diary %>%
  group_by(id) %>%
  mutate(
    firstobs = as.integer(row_number() == 1),
    state = ill + 1,
    state = as.integer(ifelse(row_number() == n(), 0, state)),
    daycare = factor(daycare, 0:1, 0:1),
    playgrp = factor(playgrp, 0:1, 0:1)
    ) %>%
  rename(weeks = stdy_wk) %>%
  ungroup() %>%
  mutate(id = as.integer(id)) %>%
  arrange(id, weeks)
```

Tally observed movement between states and sojourn times

```{r}
library(msm)
statetable.msm(state, id, data = states)
```

We have a two-state markov chain: illness (state:1) - recovery (state:2) - terminus (censor:0), terminus being the end of the study. The Q, transition matrix is laid out like so:

$$
Q = \left(\begin{array}{cc} 
-q_{12} & q_{12} \\
q_{21} & -q_{21}
\end{array}\right)
$$ 

Which can be represented diagrammatically as, 

```{r, fig.width = 6, fig.height = 6}
library(diagram)

names <- c("ARI (-)", "ARI (+)")
M <- matrix(nrow = 2, ncol = 2, byrow = TRUE, data = 0)
M[1, 1] <- paste(expression("q"[11]))
M[2, 1] <- paste(expression("q"[12]))
M[2, 2] <- paste(expression("q"[22]))
M[1, 2] <- paste(expression("q"[21]))
curves <- matrix(c(0, 0.1, 0.1, 0), byrow = TRUE, nrow = 2)
plotmat(M,
        pos = 2,
        shadow.size = 0,
        curve = curves,
        name = names,
        lwd = 1,
        box.lwd = 2,
        cex.txt = 0.8,
        self.cex = 0.5,
        self.shiftx = c(-0.1, 0.1),
        self.shifty = c(0.1, 0.1),
        self.arrpos = c(1.6, 1.5),
        arr.type = "triangle")
```

```{r, echo = FALSE, eval = FALSE}
# setwd("plots/")
# tiff("markov_diagram.tiff", height = 7, width = 7, units = "in", res = 700,
#      compression = "lzw")
# plotmat(M,
#         pos = 2,
#         shadow.size = 0,
#         curve = curves,
#         name = names,
#         lwd = 1,
#         box.lwd = 2,
#         cex.txt = 0.8,
#         self.cex = 0.5,
#         self.shiftx = c(-0.1, 0.1),
#         self.shifty = c(0.1, 0.1),
#         self.arrpos = c(1.6, 1.5),
#         arr.type = "triangle")
# dev.off()
detach('package:diagram')
```

Initial values could be set by supposing that transitions between states take place only at the observation times, fortunately the data we are working with can be said to have exact observation times. If we observe $n_{rs}$ transitions from state $r$ to state $s$, and a total of $n_{r}$ transitions from state $r$, then $q_{rs}/q_{rr}$ can be estimated by $n_{rs}/n_{r}$. Then, given a total of $T_{r}$ years spent in state $r$, the mean sojourn time $1/q_{rr}$ can be estimated as $T_{r}/n_{r}$. Thus, $n_{rs}/T_{r}$ is a crude estimate of $q_{rs}$. The msm package provides a function crudeinits.msm for calculating initial values in this way.

Initialized Q matrix, entries generated above

```{r}
Q <- matrix(c(0.0, 1.0, 1.0, 0.0), nrow = 2, ncol = 2)

crudeQ <- crudeinits.msm(state ~ weeks, id,
                         data = states,
                         censor = 0,
                         qmatrix = Q)

crudeQ
# rowSums(crudeQ)
# 0 0 (row sums constrained to be zero)
```

### Without Covariates

Running the model without covariates or censoring

```{r}
markov1 <- msm(state ~ weeks,
               subject = id,
               censor = 0,
               data = states,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov1
```

Estimated Q matrix:

```{r}
qmatrix.msm(markov1)
```

Estimated probability transition matrix:

```{r}
pmatrix.msm(markov1, ci = "normal", t = 1, cl = 0.95)
```

Estimated Sojourn Times - time spent in each state.

```{r}
sojourn.msm(markov1)
```

The interpretation of the estimated transition intensity matrix is somewhat interesting: the mean time in non-ill (non-ARI) state is 6.6 weeks (95% CI: 6.1 - 7.2 weeks) and the mean duration of ARI episodes is 1.4 weeks (95% CI: 1.3 - 1.5 weeks).

The total duration in any particular state can be estimated with bootstrapped errors:

```{r, warning = FALSE, message = FALSE}
# totals <- totlos.msm(markov1,
#                      fromt = 0,
#                      tot = 52,
#                      ci = "bootstrap",
#                      B = 100,
#                      cores = 4)

# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output/")
setwd("Rdata/output")
# saveRDS(totals, "markov1_totals52.rds")
totals <- readRDS("markov1_totals52.rds")

totals
```

Within the first year of life, the estimated total number of weeks spent in ARI episodes is 8.9 weeks (95% CI: 8.1 - 9.9).

Each entry in the estimated transition probability matrix can be interpreted as the probability of occupying state s at time = origin + t, conditionally on occupying state r at time = origin. For t = 1 (1 weeks time), the probability of an ARI is 10.1% (95% CI: 9.5% - 10.8%). At 3 weeks after birth the probability of an ARI is 16.2% (95% CI: 15.0% - 17.3%). We can plot the estimated probability trajectory for 10 simulated weeks:

```{r, eval = TRUE, echo = FALSE}
# function to simulate predictions from msm::pmatrix.msm
#' @param object of class 'msm' from msm package
#' @param time integer, time interval to estimate transition probabilities
#' @param levels factor levels for transitions in markov model
#' @param labels factor labels for transitions in markov model
#' @param covariates list of covariate values at which to estimate the transition probabilities

pmat_sim <- function(model,
                     time,
                     levels = NULL, 
                     labels = NULL,
                     covariates = NULL) {
  require(dplyr)
  df_list <- list()
  for (i in 1:time) {
    if (is.null(covariates)) {
      pmat <- pmatrix.msm(model, 
                          ci = "normal", 
                          t = i, 
                          cl = 0.95)
    } else {
      pmat <- pmatrix.msm(model, 
                          ci = "normal", 
                          t = i, 
                          cl = 0.95,
                          covariates = covariates)
    }
    estimates <- as.data.frame(as.table(pmat$estimates))
    colnames(estimates) <- c("From", "To", "P_rs")
    UB <- as.data.frame(as.table(pmat$U))
    LB <- as.data.frame(as.table(pmat$L))
    estimates$UB <- UB$Freq
    estimates$LB <- LB$Freq
    estimates$time <- as.numeric(i)
    df_list[[i]] <- estimates
  } # end for
  df <- bind_rows(df_list)
  if (!is.null(levels)) {
    df <- df %>% 
      mutate(
        transition = paste(From, To, sep = " - "),
        transition = factor(transition,
                            levels = levels,
                            labels = labels)
      ) %>%
      select(-From, -To)
  } # end if
  df
}
```

```{r}
Qlevels <- paste("State", 1:ncol(Q))
Qlevels <- expand.grid(Qlevels, Qlevels)
Qlevels <- mutate(Qlevels, transition = paste(Var1, "-", Var2))[, 3]

# choose what you want to call the transitions
Qlabels <- c("ARI (-)", "ARI (+)")
Qlabels <- expand.grid(Qlabels, Qlabels)
Qlabels <- mutate(Qlabels, transition = paste(Var1, "-", Var2))[, 3]

pmat <- pmat_sim(markov1, 
                 time = 10, 
                 levels = Qlevels, 
                 labels = Qlabels,
                 covariates = NULL)

# this includes everything, as a check that the model is specified correctly
pmat %>%
  arrange(transition, time) %>%
  ggplot(aes(x = time)) %>%
  add(geom_line(aes(y = P_rs))) %>%
  add(geom_line(aes(y = UB), linetype = 2)) %>%
  add(geom_line(aes(y = LB), linetype = 2)) %>%
  add(facet_wrap(~transition, nrow = nrow(Q), ncol = ncol(Q))) %>%
  add(theme_base()) %>%
  add(labs(
    x = "\n Time since birth, weeks",
    y = expression(hat(P)[rs]),
    caption = "--- Gaussian 95% confidence bands"
  ))
```

All infants exit the study (END is an absorbing state), i.e. in the above plot, ARI (-) - END and ARI (+) - END are the same.

Probabilities for the first year of life (52 weeks)

```{r, fig.width = 7, fig.height = 5, warning = FALSE}
setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output/")
# pmat <- pmat_sim(markov1, 52, levels = Qlevels, labels = Qlabels)
# saveRDS(pmat, "markov1_pmat52.rds")
pmat <- readRDS("markov1_pmat52.rds")

# subset labels
# pmat_red <- pmat[pmat$transition %in% Qlabels[c(1:2, 4:5)], ]

# re-orient as q11, q12, q21, q22 
pmat$transition <- factor(pmat$transition,
                          levels(pmat$transition)[c(1, 3, 4, 2)])

p <- pmat %>%
  arrange(transition, time) %>%
  ggplot(aes(x = time)) %>%
  add(geom_line(aes(y = P_rs))) %>%
  add(geom_line(aes(y = UB), linetype = 2)) %>%
  add(geom_line(aes(y = LB), linetype = 2)) %>%
  add(facet_wrap(~transition, 
                 nrow = length(levels(pmat$transition)) / 2, 
                 ncol = length(levels(pmat$transition)) / 2 )) %>%
  add(theme_minimal()) %>%
  add(labs(
    x = "\n Time since birth, weeks",
    y = expression(hat(P)[rs]),
    caption = "--- Gaussian 95% confidence bands"
  ))
p
```

```{r, echo = FALSE, eval = FALSE}
# ggsave("pmat_1.tiff", p, device = "tiff",
#        path = "S:/MartinEpi/Analysis/IllburdenDaycare/IllburdenDaycare/plots",
#        width = 8, height = 6, units = "in", dpi = 700)
```

The plot above describes the probability (independent axis) of transition into the state defined in the facets, at a particular time in the infants life (dependent axis). Specifically, it describes the probability of occupying state $s \, (ARI(-) \, or \, ARI(+))$ at time $t + u$, conditionally on occupying state $r \, (ARI(-) \, or \, ARI(+))$ at time $u$. For these data, the top right corner describes the probability of being $ARI (+)$, at time $t + u$, given that the infant was in state $ARI (-)$ at time $t$. The probability of never having an ARI episode, throughout the course of infant life up to 52 weeks, decreases exponentially with time (top left corner: ARI(-) - ARI(-)). The probability of acquiring ARI episodes 

The goodness-of-fit can be measured in several ways, the first is a rough idea of observed vs. expected prevalences. The msm::prevalence.msm() procedure estimates the observed numbers of individuals occupying each state at a series of times and compares these with forecasts from the fitted model.

```{r}
prev1 <- prevalence.msm(markov1, ci = "bootstrap", B = 100, cores = 4)
prev1
```

```{r, fig.width = 8, fig.height = 4}
plot.prevalence.msm(markov1, 
                    legend.pos = c(0, 100),
                    col.obs = "black", 
                    col.exp = "red")
```

The model fits a general trend line to our data that does not fit very well, it does capture the overall trend, however, it expects a faster build up in occupying the ARI (+) state (state 2, t=0 to t=10).

```{r}
t <- seq(1, 107, length.out = 11)

plot(t, as.numeric(prev1$Observed[, 2]), 
     type = "p", pch = 19,
     xlab = "Infant Age (weeks)",
     ylab = "Prevalence (%)",
     ylim = c(0, 30))
lines(t, as.numeric(prev1$Expected$estimates[, 2]),
      type = "l",
      lty = 1)
lines(t, as.numeric(prev1$Expected$ci[, , 1][, 2]), lty = 2)
lines(t, as.numeric(prev1$Expected$ci[, , 2][, 2]), lty = 2)
legend(0, 30, c("Observed", "Expected"), pch = c(19, NA), lty = c(NA, 1))
```

### With Covariates

> Sex

```{r}
states_cov <- demo %>%
  select(id, hbov.pos, female, siblings) %>%
  mutate(id = as.integer(id)) %>%
  right_join(states, by = "id") %>%
  arrange(id, weeks)
```

```{r}
markov2 <- msm(state ~ weeks,
               subject = id,
               covariates = ~female,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov2
```

```{r}
hazard.msm(markov2)
```

Infant sex has no statistically significant bearing on rate of ARI incidence in this cohort (HR: 0.93, 95% CI: 0.78 - 1.10).

```{r, eval = TRUE, echo = FALSE}
# function to perform bootstrap estimation on sojourn difference estimates
# requires libraries msm, dplyr
# cluster should be called 'id', for now...msm issue
#' @param formula, object of class 'formula' for use in msm::msm(covariates = ,)
#' @param data, data.frame for msm::msm()
#' @param B boostrap replicates
#' @param pergrp number of groups per bootstrap replicate
#' @param grp, charcter string describing subjects in data parameter
#' @param difflist object of type 'list' to pass to msm::sojourn.msm(covariates = ,)
#' @param Q object of type 'matrix', initial/crude matrix for setting up Q tranisiton matrix in msm::msm()
#' @param censor indicator in data$states denoting censored observations/states

bootSojourn <- function(formula,
                        data,
                        B = 100,
                        cluster,
                        difflist,
                        qmatrix,
                        censor) {
  
  sojourn_diff <- matrix(NA, nrow = B, ncol = 1)
  
  pb <- txtProgressBar(min = 1, max = B, style = 3)
  for (i in 1:B) {
    
    data[, cluster] <- as.factor(data[, cluster])
    
    clust_samp <- sample(levels(data[[cluster]]), replace = TRUE)
    
    samp <- data[data[[cluster]] %in% clust_samp, ]
    
    markov <- msm(state ~ weeks,
                  subject = id,
                  covariates = formula,
                  censor = censor,
                  data = samp,
                  qmatrix = qmatrix,
                  gen.inits = TRUE)
    
    sojourn0 <- sojourn.msm(markov, covariates = difflist[[1]])
    sojourn1 <- sojourn.msm(markov, covariates = difflist[[2]])
    
    sojourn_diff[i, 1] <- sojourn1[2, 1] - sojourn0[2, 1]
    
    setTxtProgressBar(pb, i)
  }
  
  result <- data.frame(result = rep(NA, 2))
  row.names(result) <- c("Mean (SD):", "Median (95% CI):")
  
  result[1, ] <- paste0(round(mean(sojourn_diff), 2), 
                        " (",
                        round(sd(sojourn_diff), 2),
                        ")")
  
  result[2, ] <- paste0(round(quantile(sojourn_diff, 0.5), 2),
                        " (",
                        round(quantile(sojourn_diff, 0.025), 2),
                        ", ",
                        round(quantile(sojourn_diff, 0.975), 2),
                        ")")
  
  list(sojourn_diff = sojourn_diff, results = result)
}
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(female = 0), list(female = 1))

female_boot <- bootSojourn(formula = as.formula(~female), 
                           data = states_cov, 
                           B = 1000, 
                           cluster = "id", 
                           difflist = difflist,
                           qmatrix = crudeQ,
                           censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(female_boot, "fem_boot_sojourn.rds")
female_boot <- readRDS("fem_boot_sojourn.rds")
```

```{r}
female_boot$results
```

> siblings

```{r}
markov3 <- msm(state ~ weeks,
               subject = id,
               covariates = ~siblings,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov3
```

```{r}
hazard.msm(markov3)
```

Having siblings has no bearing on ARI incidence (HR: 1.08, 95% CI: 0.91 - 1.28)

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(siblings = 0), list(siblings = 1))

sibs_boot <- bootSojourn(formula = as.formula(~siblings), 
                         data = states_cov, 
                         B = 1000,
                         cluster = "id", 
                         difflist = difflist,
                         qmatrix = crudeQ,
                         censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(sibs_boot, "sibs_boot_sojourn.rds")
sibs_boot <- readRDS("sibs_boot_sojourn.rds")
```

```{r}
sibs_boot$results
```

> Siblings and Sex

```{r}
markov4 <- msm(state ~ weeks,
               subject = id,
               covariates = ~female + siblings + female * siblings,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov4
```

```{r}
hazard.msm(markov4)
```

One could argue that, given differences in behavior between males and females, contact with siblings could affect the rate of respiratory illnesses. Infants of this age may be too young to show these behavioral differences, explaining the lack of an effect here and in the model above (markov3).

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(siblings = 0, female = 0),
                 list(siblings = 1, female = 1))
form <- as.formula(~female + siblings + female * siblings)

femXsibs_boot <- bootSojourn(formula = form, 
                             data = states_cov,
                             B = 1000,
                             cluster = "id", 
                             difflist = difflist,
                             qmatrix = crudeQ,
                             censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(femXsibs_boot, "femaleXsibs_boot_sojourn.rds")
femXsibs_boot <- readRDS("femaleXsibs_boot_sojourn.rds")
```

```{r}
femXsibs_boot$results
```

> Daycare Attendance

```{r}
markov5 <- msm(state ~ weeks,
               subject = id,
               covariates = ~daycare,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov5
```

```{r}
hazard.msm(markov5)
```

Estimated transition intensity matrix and transition probability matrix for the first 30 weeks of infant life. For this infant cohort, Children first began daycare at a median age of 30 weeks (range: 6 - 87 weeks).

Daycare attendance positively affects rate of ARI: daycare attendees are 1.76 times more lkely (76%) to experience an ARI episode.

```{r, warning = FALSE}
setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output/")

# totals1 <- totlos.msm(markov5,
#                       fromt = 0, tot = 52,
#                       covariates = list(1),
#                       ci = "bootstrap",
#                       B = 100,
#                       cores = 4)

# saveRDS(totals1, "markov5_totals1.rds")
totals1 <- readRDS("markov5_totals1.rds")

# totals0 <- totlos.msm(markov5,
#                       fromt = 1, tot = 52,
#                       covariates = list(0),
#                       ci = "bootstrap",
#                       B = 100,
#                       cores = 4)

# saveRDS(totals0, "markov5_totals0.rds")
totals0 <- readRDS("markov5_totals0.rds")
```

```{r}
totals1
```

For those in daycare, the expected total duration of ARI episodes is 14.6 weeks (95% CI: 12.0 - 17.1 weeks), compare this with non-daycare attendees...

```{r}
totals0
```

where the estimated total duration of ARI episodes is 7.2 weeks (95% CI: 6.39 - 7.94).

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(daycare = 0), list(daycare = 1))
form <- as.formula(~daycare)

daycare_boot <- bootSojourn(formula = form, 
                            data = states_cov,
                            B = 1000,
                            cluster = "id", 
                            difflist = difflist,
                            qmatrix = crudeQ,
                            censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(daycare_boot, "daycare_boot_sojourn.rds")
daycare_boot <- readRDS("daycare_boot_sojourn.rds")
```

```{r}
daycare_boot$results
```

```{r, echo = TRUE, eval = FALSE}
pmat_dc0 <- pmat_sim(markov5, 
                     time = 52, 
                     levels = Qlevels, 
                     labels = Qlabels,
                     covariates = list(daycare = 0))

pmat_dc1 <- pmat_sim(markov5,
                     time = 52, 
                     levels = Qlevels, 
                     labels = Qlabels,
                     covariates = list(daycare = 1))
```

```{r, echo = FALSE, eval = FALSE}
setwd("Rdata/output/")
saveRDS(pmat_dc0, "pmat_dc0.rds")
saveRDS(pmat_dc1, "pmat_dc1.rds")
```

```{r, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
setwd("Rdata/output/")
pmat_dc0 <- readRDS("pmat_dc0.rds")
pmat_dc1 <- readRDS("pmat_dc1.rds")
```

combine data frames and plot

```{r}
pmat_dc1$daycare <- 1
pmat_dc0$daycare <- 0

pmat_dc <- rbind(pmat_dc1, pmat_dc0)
pmat_dc$daycare <- factor(pmat_dc$daycare,
                          0:1, 
                          c("No Daycare Attendance", "Daycare Attendance"))
pmat_dc <- filter(pmat_dc, transition %in% Qlabels[c(3, 2)])
pmat_dc$transition <- factor(pmat_dc$transition,
                             levels = levels(pmat_dc$transition)[3:2])

pmat_dc.plot <- pmat_dc %>%
  ggplot(aes(x = time, y = P_rs, fill = daycare, ymin = LB, ymax = UB)) %>%
  add(geom_line(aes(color = daycare))) %>%
  add(geom_ribbon(alpha = 0.2)) %>%
  add(theme_minimal(16)) %>%
  add(theme(
    legend.position = c(0.2, 0.9)
    )) %>%
  add(scale_color_manual(name = "", values = set1[1:2])) %>%
  add(scale_fill_manual(name = "", values = set1[1:2])) %>%
  add(guides(color = guide_legend(override.aes = list(fill = NA)))) %>%
  add(facet_wrap(~transition)) %>%
  add(labs(
    x = "Infant Age (weeks)",
    y = expression(hat(P)[rs])
  ))
pmat_dc.plot
```

We can extract estimated quantities and calculated entities (matrices) to be further used in the markovchain package, this way we can get steady states, plots, etc.

```{r, warning = FALSE, message = FALSE}
library(markovchain)

ari <- c("ARI(-)", "ARI(+)")

pmat0 <- pmatrix.msm(markov5, covariates = list(daycare = 0))
pmat0 <- matrix(c(pmat0[1, 1], pmat0[1, 2],
                  pmat0[2, 1], pmat0[2, 2]), 
                byrow = TRUE, nrow = 2,
                dimnames = list(ari, ari))
pmat0 <- new("markovchain", 
             states = ari, 
             byrow = TRUE, 
             transitionMatrix = pmat0,
             name = "pmat0")

pmat1 <- pmatrix.msm(markov5, covariates = list(daycare = 1))
pmat1 <- matrix(c(pmat1[1, 1], pmat1[1, 2],
                  pmat1[2, 1], pmat1[2, 2]), 
                byrow = TRUE, nrow = 2,
                dimnames = list(ari, ari))
pmat1 <- new("markovchain", 
             states = ari, 
             byrow = TRUE, 
             transitionMatrix = pmat1,
             name = "pmat1")
```

The steady state of a system is the probability that,

$$
\begin{align}
0 \le \pi_j \le 1 \\
\sum_{j\in S}\pi_j = 1 \\
\pi * P = \pi
\end{align}
$$
steady states are associated to P eigenvalues = 1. Therefore the steady states can be identified by the following:

1. decompose the transition matrix into eigenvalues and eigenvectors
2. consider only eigenvectors corresponding to eigenvalues = 1
3. normalize such eigenvalues so that the sum of their components = 1

For those not in daycare at time $t$

```{r}
steadyStates(pmat0)
```

For those in daycare at time $t$

```{r}
steadyStates(pmat1)
```

The way to think of this is, these are the probabilities tha the system will be found in each of the states at a given future time, so it's dependent on a future time. However, as time approaches infinity, the states approaches a limiting value (most of the time). These stable probabilities are what we are estimating. If the system starts so that each state has a probability equal to its stable probability, then these probabilityes will persist for all time, i.e., the system is in a "steady state".

```{r, echo = FALSE, eval = TRUE}
detach('package:markovchain')
```

> HBoV-1 Shedding

```{r}
markov6 <- msm(state ~ weeks,
               subject = id,
               covariates = ~hbov.pos,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov6
```

```{r}
hazard.msm(markov6)
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(hbov.pos = 0), list(hbov.pos = 1))
form <- as.formula(~hbov.pos)

boca_boot <- bootSojourn(formula = form, 
                         data = states_cov,
                         B = 1000,
                         cluster = "id", 
                         difflist = difflist,
                         qmatrix = crudeQ,
                         censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(boca_boot, "boca_boot_sojourn.rds")
boca_boot <- readRDS("boca_boot_sojourn.rds")
```

```{r}
boca_boot$results
```

> Daycare and HBoV-1 shedding

```{r}
markov7 <- msm(state ~ weeks,
               subject = id,
               covariates = ~daycare + hbov.pos + daycare * hbov.pos,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov7
```

```{r}
hazard.msm(markov7)
```

The carriage time of an ARI associated organism, Human Bocavirus 1, may confound the effect of daycare attendance on ARI incidence. Here, there is no significant interaction between daycare attendance and HBoV-1 shedding on the incidence of ARI (HR: 0.81, 95% CI: 0.52 - 1.26).

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(daycare = 0, hbov.pos = 0), 
                 list(daycare = 1, hbov.pos = 1))
form <- as.formula(~daycare + hbov.pos + daycare * hbov.pos)

dc_boca_boot <- bootSojourn(formula = form, 
                            data = states_cov,
                            B = 1000,
                            cluster = "id", 
                            difflist = difflist,
                            qmatrix = crudeQ,
                            censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(dc_boca_boot, "dc_boca_boot_sojourn.rds")
dc_boca_boot <- readRDS("dc_boca_boot_sojourn.rds")
```

```{r}
dc_boca_boot$results
```

> Playgroup Association

```{r}
markov8 <- msm(state ~ weeks,
               subject = id,
               covariates = ~playgrp,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov8
```

```{r}
hazard.msm(markov8)
```

Infants in play groups (defined how?) are more at risk of incurring ARI episodes than infants not attending a play group by 24% (HR: 1.24, 95% CI: 1.05 - 1.47).

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(playgrp = 0), list(playgrp = 1))
form <- as.formula(~playgrp)

playgrp_boot <- bootSojourn(formula = form, 
                            data = states_cov,
                            B = 1000,
                            cluster = "id", 
                            difflist = difflist,
                            qmatrix = crudeQ,
                            censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(playgrp_boot, "playgrp_boot_sojourn.rds")
playgrp_boot <- readRDS("playgrp_boot_sojourn.rds")
```

```{r}
playgrp_boot$results
```

> Playgroup and Daycare Attendance

The correlation between daycare and playgroup attendance is weak, so I can put them both in the model:

```{r}
tab <- xtabs(~day_care + play.group, data = demo)
vcd::assocstats(tab)
```

Cramer's V - a strength of correlation estimation technique for categorical data - is 0.27, weakly correlated. If we look at the data time-series view of the Cramer's V, the correlation is very weak:

```{r}
tab <- xtabs(~daycare + playgrp, data = states_cov)
vcd::assocstats(tab)
```

Subject-wise, it varys:

```{r}
tmp <- states_cov %>%
  group_by(id) %>%
  mutate(
    pg = as.numeric(playgrp) - 1,
    dc = as.numeric(daycare) - 1,
    sumpg = sum(pg),
    sumdc = sum(dc)
  ) %>%
  ungroup() %>%
  filter(sumpg != 0 & sumdc != 0) %>%
  select(id, playgrp, daycare)
# length(unique(tmp$id))
# only 15

fcor <- function(df) {
  tab <- xtabs(~daycare + playgrp, data = df)
  return(data.frame(COR = vcd::assocstats(tab)$cramer))
}

plyr::ddply(tmp, "id", fcor) %>%
  mutate(id = factor(id)) %>%
  ggplot() %>%
  add(geom_linerange(aes(x = id, ymin = 0, ymax = COR))) %>%
  add(geom_hline(yintercept = 0.5, color = 'red')) %>%
  add(theme_trueMinimal()) %>%
  add(labs(y = "\nCorrelation \n Daycare vs. Playgroup attendance"))
```

Only 15 individuals attended a daycare and engaged in playgroup activities at the same time and the correlations were only strong for 5 infants.

```{r}
markov9 <- msm(state ~ weeks,
               subject = id,
               covariates = ~playgrp + daycare + playgrp * daycare,
               censor = 0,
               data = states_cov,
               qmatrix = crudeQ,
               gen.inits = TRUE)
markov9
```

```{r}
hazard.msm(markov9)
```

Attending daycare while also engaging in play groups during that same week has no statistically signficant affect on ARI incidence (HR: 0.7, 95% CI: 0.48 - 1.02), After adjustment, daycare attendance and playgroup engagement affect the rate of ARI with similar strengths of association and variance as their respective models, alone.

```{r, fig.width = 8, fig.height = 4}
plot.prevalence.msm(markov9, 
                    legend.pos = c(20, 100),
                    col.obs = "black",
                    col.exp = "red")
```

```{r, echo = TRUE, eval = FALSE}
prev2 <- prevalence.msm(markov9, ci = "normal", B = 100, cores = 4)
```

```{r, echo = FALSE, eval = FALSE}
saveRDS(prev2, "Rdata/markov_prevalence_dcpg.rds")
```

```{r, echo = FALSE, eval = TRUE}
prev2 <- readRDS("Rdata/markov_prevalence_dcpg.rds")
```

```{r}
t <- seq(1, 107, length.out = 11)

plot(t, as.numeric(prev2$Observed[, 2]), 
     type = "p", pch = 19,
     xlab = "Infant Age (weeks)",
     ylab = "Prevalence (%)",
     ylim = c(0, 30))
lines(t, as.numeric(prev2$Expected$estimates[, 2]),
      type = "l",
      lty = 1)
lines(t, as.numeric(prev2$Expected$ci[, , 1][, 2]), lty = 2)
lines(t, as.numeric(prev2$Expected$ci[, , 2][, 2]), lty = 2)
legend(0, 30, c("Observed", "Expected"), pch = c(19, NA), lty = c(NA, 1))
```

This model provides better fit ($-2logLik = 6197$ compare to base model $-2logLik = 6294$) and estimates prevalences much better. The model still inaccurately estimates the early onset ARI episodes.

Comparing sojourn times between levels of daycare and playgroup attendance:

Without daycare or playgroup attendance:

```{r}
sojourn.msm(markov9, covariates = list(daycare = 0, playgrp = 0))
```

In daycare, but not participating in play groups

```{r}
sojourn.msm(markov9, covariates = list(daycare = 1, playgrp = 0))
```

Participating in a play group but not attending daycare

```{r}
sojourn.msm(markov9, covariates = list(daycare = 0, playgrp = 1))
```

Attending a daycare and participating in a play group

```{r}
sojourn.msm(markov9, covariates = list(daycare = 1, playgrp = 1))
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(daycare = 0, playgrp = 0), 
                 list(daycare = 1, playgrp = 1))
form <- as.formula(~playgrp + daycare + playgrp * daycare)

dcpg_boot <- bootSojourn(formula = form, 
                         data = states_cov,
                         B = 1000,
                         cluster = "id", 
                         difflist = difflist,
                         qmatrix = crudeQ,
                         censor = 0)
```

```{r, warning = FALSE}
setwd("Rdata/output")
# saveRDS(dcpg_boot, "dcpg_boot_sojourn.rds")
dcpg_boot <- readRDS("dcpg_boot_sojourn.rds")
```

```{r}
dcpg_boot$results
```

```{r, warning = FALSE}
cov.list <- list(list(daycare = 0, playgrp = 0),
                 list(daycare = 1, playgrp = 0),
                 list(daycare = 0, playgrp = 1),
                 list(daycare = 1, playgrp = 1))

sojourn.df <- data.frame(
  set = c("No daycare, No playgroup",
          "Daycare, No playgroup", 
          "No daycare, Playgroup", 
          "Daycare, Playgroup"), 
  estimates = rep(NA, 4),
  L = rep(NA, 4), 
  U = rep(NA, 4)
  )

# for (i in 1:length(cov.list)) {
#   sojourn <- sojourn.msm(markov9, 
#                          covariates = cov.list[[i]], 
#                          ci = "bootstrap",
#                          B = 100)
#   sojourn.df[i, 2] <- sojourn[2, 1]
#   sojourn.df[i, 3] <- sojourn[2, 3]
#   sojourn.df[i, 4] <- sojourn[2, 4]
# }

# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output/")
setwd("Rdata/output")
# saveRDS(sojourn.df, "full_sojourn.rds")
sojourn.df <- readRDS("full_sojourn.rds")

sojourn.df
```

```{r, fig.width = 6, fig.height = 6}
levs <- c("No daycare, No playgroup",
          "Daycare, No playgroup",
          "No daycare, Playgroup",
          "Daycare, Playgroup")

labs <- gsub(", ", "\n", levs)

soj.plot <- sojourn.df %>%
  mutate(set = factor(set, levels = levs, labels = labs)) %>%
  ggplot(aes(set)) %>%
  add(geom_point(aes(y = estimates), size = 3)) %>%
  add(geom_errorbar(aes(ymin = L, ymax = U), width = 0.2)) %>%
  add(theme_trueMinimal(16)) %>%
  add(labs(
    x = "Daycare attendance and playgroup activity",
    y = "Estimated sojourn (weeks) in ARI episodes"
  )) %>%
  add(scale_y_continuous(limits = c(1, 2.7)))
soj.plot
```

> Daycare + Sex + Daycare * Sex

```{r}
markov10 <- msm(state ~ weeks,
                subject = id,
                covariates = ~female + daycare + female * daycare,
                censor = 0,
                data = states_cov,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov10
```

```{r}
hazard.msm(markov10)
```

> Daycare + Siblings + Daycare * Siblings

```{r}
markov11 <- msm(state ~ weeks,
                subject = id,
                covariates = ~siblings + daycare + siblings * daycare,
                censor = 0,
                data = states_cov,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov11
```

```{r}
hazard.msm(markov11)
```

Forest plot of hazards and CIs by daycare attendance and covariates of interest

```{r}
# collect hazards
hazards <- lapply(mget(ls(pattern = "markov[2-9]|markov1[0-1]")), hazard.msm)

# find hazards with three covariates (X1 * X2)
hazards <- hazards[lengths(hazards) == 3]

# collect hazards for third covariate
Xhazards <- vector("list", length(hazards))
for (i in 1:length(Xhazards)) {
  Xhazards[[i]] <- data.frame(hazards[[i]][[3]])
  Xhazards[[i]]$cov <- names(hazards[[i]][3])
}
Xhazards <- do.call(rbind, Xhazards)

# add markov5 - ~ daycare
tmp <- data.frame(hazard.msm(markov5)[[1]])
tmp$cov <- "Daycare"
Xhazards <- rbind(Xhazards, tmp)

Xhazards$transition <- ""
Xhazards$transition[grep("^State 1", row.names(Xhazards))] <- "ARI (-) - ARI (+)"
Xhazards$transition[grep("^State 2", row.names(Xhazards))] <- "ARI (+) - ARI (-)"
row.names(Xhazards) <- NULL

Xhazards$cov <- factor(Xhazards$cov,
                   levels = c("Daycare",
                              "female1:daycare1",
                              "siblings1:daycare1",
                              "daycare1:hbov.pos1",
                              "playgrp1:daycare1",
                              "female1:siblings1"),
                   labels = c("Daycare",
                              "Daycare\nFemale",
                              "Daycare\nSiblings",
                              "Daycare\nHBoV-1",
                              "Daycare\nPlaygroup",
                              "Female\nSiblings"))
```

```{r}
Xhaz.plot <- Xhazards %>%
  filter(cov != "Female\nSiblings") %>%
  ggplot(aes(x = cov, y = HR, ymin = L, ymax = U, color = transition)) %>%
  add(geom_pointrange(position = position_dodge(width = 0.2))) %>%
  add(geom_hline(yintercept = 1, lty = 2)) %>%
  add(geom_rect(data = filter(Xhazards, cov == "Daycare"),
                aes(xmin = -Inf, xmax = 1.5, ymin = -Inf, ymax = Inf),
                alpha = 0.2,
                fill = "grey",
                inherit.aes = FALSE)) %>%
  add(theme_trueMinimal(16)) %>%
  add(theme(
    legend.position = c(0.85, 0.95),
    legend.justification = "top"
  )) %>%
  add(labs(
    x = "Interaction Term",
    y = "Hazard Ratio",
    color = "Transition"
  )) %>%
  add(scale_color_manual(values = set1[1:2]))
Xhaz.plot
```

Putting some select figures together

```{r, width = 18, height = 8}
library(gridExtra)
grid.arrange(arrangeGrob(pmat_dc.plot, Xhaz.plot, nrow = 2), 
                  soj.plot, 
                  nrow = 1, 
                  widths = c(3, 2))
```

```{r, eval = FALSE, echo = FALSE}
# library(cowplot)
# setwd("..")
# 
# left <- plot_grid(pmat_dc.plot, Xhaz.plot, labels = c('A', 'B'), nrow = 2)
# g <- plot_grid(left, soj.plot, labels = c('', 'C'), rel_widths = c(1.8, 1))
# ggsave("plots/markov_plot.tiff", g,
#        height = 8, width = 18, units = "in",
#        dpi = 1200,
#        compression = "lzw")
```

### Daycare Subset

34 infants were enrolled in daycare during the course of this study. The markov models made so far (markov5) included all 86 individuals. A subset analysis of the 34 individuals may reveal a different estimate to the effect of daycare.

```{r}
states_red <- demo %>%
  filter(day_care == 1) %>%
  select(id) %>%
  mutate(id = as.integer(id)) %>%
  left_join(states_cov, by = "id")

length(unique(states_red$id))
```

> Female Sex

```{r}
markov12 <- msm(state ~ weeks,
                subject = id,
                covariates = ~female,
                censor = 0,
                data = states_red,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov12
```

```{r}
hazard.msm(markov12)
```

```{r}
qmatrix.msm(markov12, covariates = list(female = 1))
```

```{r}
sojourn.msm(markov12, covariates = list(female = 1))
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(female = 0), list(female = 1))
form <- as.formula(~female)

female_boot <- bootSojourn(formula = form,
                           data = states_red,
                           B = 1000,
                           cluster = "id", 
                           difflist = difflist,
                           qmatrix = crudeQ,
                           censor = 0)
```

```{r}
female_boot$results
```

> Siblings

```{r}
markov13 <- msm(state ~ weeks,
                subject = id,
                covariates = ~siblings,
                censor = 0,
                data = states_red,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov13
```

```{r}
hazard.msm(markov13)
```

```{r}
qmatrix.msm(markov13, covariates = list(siblings = 1))
```

```{r}
sojourn.msm(markov13, covariates = list(siblings = 1))
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(siblings = 0), list(siblings = 1))
form <- as.formula(~siblings)

sibs_boot <- bootSojourn(formula = form,
                         data = states_red,
                         B = 1000,
                         cluster = "id", 
                         difflist = difflist,
                         qmatrix = crudeQ,
                         censor = 0)
```

```{r}
sibs_boot$results
```

> Daycare Attendance

```{r}
markov13 <- msm(state ~ weeks,
                subject = id,
                covariates = ~daycare,
                censor = 0,
                data = states_red,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov13
```

```{r}
hazard.msm(markov13)
```

```{r}
qmatrix.msm(markov13)
```

```{r}
sojourn.msm(markov13)
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(daycare = 0), list(daycare = 1))
form <- as.formula(~daycare)

dcpg_boot <- bootSojourn(formula = form,
                         data = states_red,
                         B = 1000,
                         cluster = "id", 
                         difflist = difflist,
                         qmatrix = crudeQ,
                         censor = 0)
```

```{r}
dcpg_boot$results
```

> HBoV-1 Shedding

```{r}
markov14 <- msm(state ~ weeks,
                subject = id,
                covariates = ~hbov.pos,
                censor = 0,
                data = states_red,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov14
```

```{r}
hazard.msm(markov14)
```

```{r}
qmatrix.msm(markov14, covariates = list(hbov.pos = 1))
```

```{r}
sojourn.msm(markov14, covariates = list(hbov.pos = 1))
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(hbov.pos = 0), list(hbov.pos = 1))
form <- as.formula(~hbov.pos)

boca_boot <- bootSojourn(formula = form,
                           data = states_red,
                           B = 1000,
                           cluster = "id", 
                           difflist = difflist,
                           qmatrix = crudeQ,
                           censor = 0)
```

```{r}
boca_boot$results
```

> Playgroup Attendance

```{r}
markov15 <- msm(state ~ weeks,
                subject = id,
                covariates = ~playgrp,
                censor = 0,
                data = states_red,
                qmatrix = crudeQ,
                gen.inits = TRUE)
markov15
```

```{r}
hazard.msm(markov15)
```

```{r}
qmatrix.msm(markov15, covariates = list(playgrp = 1))
```

```{r}
sojourn.msm(markov15, covariates = list(playgrp = 1))
```

```{r, echo = TRUE, eval = FALSE}
difflist <- list(list(playgrp = 0), list(playgrp = 1))
form <- as.formula(~playgrp)

pg_boot <- bootSojourn(formula = form,
                       data = states_red,
                       B = 1000,
                       cluster = "id", 
                       difflist = difflist,
                       qmatrix = crudeQ,
                       censor = 0)
```

```{r}
pg_boot$results
```

```{r, echo = FALSE, eval = TRUE}
rm(list = ls(pattern = "markov|hazard|totals|boot"))
detach('package:msm')
```

## Recurrent Events Approach

```{r}
recur <- states_cov %>%
  group_by(id) %>%
  mutate(last = row_number() == n()) %>%
  filter(last | ill == 1) %>%
  mutate(
    t.stop = weeks,
    t.start = lag(t.stop),
    t.start = ifelse(is.na(t.start), 0, t.start),
    time = t.stop - t.start
  ) %>%
  select(-firstobs, -sum, -state, -last) %>%
  ungroup() %>%
  data.frame()

dim(recur)
```

```{r}
states_cov %>%
  filter(ill == 1) %>%
  select(id) %>%
  table() %>%
  data.frame() %>%
  summarise(
    n = n(),
    mean = mean(Freq),
    sd = sd(Freq),
    median = median(Freq),
    min = min(Freq),
    max = max(Freq)
    )
```

The median number of ARI episodes is 16.4, ranging from 1 episode to 46 episodes

Shared frailty model:

The hazard function, conditional on the shared frailty term $\omega_j$

$$\lambda_{ij}(t|\omega_j)=\lambda_0(t)_i \omega_j \exp(\beta^\prime X_{ij})$$

Where $X_{ij}$ could be time-varying $X_{ij}(t)$ (eg. daycare and playgroup) 

```{r, warning = FALSE, message = FALSE}
library(frailtypack)

recur.mod1 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + daycare,
                           recurrentAG = TRUE,
                           data = recur,
                           hazard = "Weibull")
recur.mod1
```

The output states the parameters of the Weibull hazard function are $\Theta = \left\{\alpha, \gamma \right\}=\left\{1.54, 17.02\right\}$

```{r}
plot(density(rweibull(1500, shape = 1.54, scale = 17.02)))
```

The baseline Weibull hazard function, $\lambda(t) = \alpha t^{\alpha - 1}/\gamma^\alpha$ and survival function $S(t) = e^{-(t / \gamma)^\alpha}$

```{r}
par(mfrow = c(1, 2))
plot(recur.mod1, color = 1)
plot(recur.mod1, type.plot = "Survival", conf.bands = TRUE, color = 1)
```

Semiparametric shared frailty with spline fit hazard function

```{r}
recur.mod2 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = 10000,
                           data = recur,
                           hazard = "Splines",
                           cross.validation = TRUE)
recur.mod2
```

```{r}
summary(recur.mod2)
```

Hazard and survival function

```{r, fig.width = 7, fig.height = 4}
par(mfrow = c(1, 2))
plot(recur.mod2, color = 1)
plot(recur.mod2, type.plot = "Survival", conf.bands = TRUE, color = 1)
```

### Stratified

```{r, eval = TRUE, echo = FALSE}
# function to extract survival probabilities from frailtyPenal() fit objects
# with stratified variables
#' @param fit Object of class frailtyPenal with or without stratified covariate, strata()
#' @param strata character vector of strata names, default is NULL
#' @value object of class data.frame() with columns Strata, Surv (survival probability), LB (95% CI lower bound), UB (95% CI upper bound)

extractStrataFit <- function(fit, strata = NULL) {
  header <- c("Surv", "LB", "UB", "Strata", "Time")
  if (!is.null(strata)) {
    strata1 <- as.data.frame(fit$surv[, , 1])
    strata1$strata <- strata[1]
    strata1$time <- as.numeric(rownames(strata1))
    
    strata2 <- as.data.frame(fit$surv[, , 2])
    strata2$strata <- strata[2]
    strata2$time <- as.numeric(rownames(strata2))
    
    df <- data.frame(rbind(strata1, strata2))
    colnames(df) <- header
    return(df)
  } else {
    df <- data.frame(fit$surv[, , 1])
    df$time <- as.numeric(rownames(df))
    colnames(df) <- header[c(1:3, 5)]
    return(df)
  }
}
```

> Stratified by sex

```{r}
strat.mod3 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + 
                             + strata(female) + daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = c(10000, 10000),
                           data = recur,
                           hazard = "Splines")

recur.mod3 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + 
                             + female + daycare + female * daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = 10000,
                           data = recur,
                           hazard = "Splines")
```

```{r}
recur.mod3
summary(recur.mod3)
```

```{r}
# function to plot survival curves extracted from frailtyPenal class objects
#' @param fit Object of class frailtyPenal with or without stratified covariate, strata()
#' @param strata character vector of strata names, default is NULL
#' @param xlab x-axis label, default is empty string ("")
#' @param ylab y-axis label, default is empty string ("")
#' @param legendpos numeric vector of length 2, acceptable values between 0, 1

plotStratSurv <- function(fit,
                          strata,
                          xlab = "",
                          ylab = "",
                          legendpos = c(0.8, 0.8)) {
  extractStrataFit(fit, strata) %>%
  ggplot(aes(x = Time, y = Surv, ymin = LB, ymax = UB, fill = Strata)) %>%
  add(geom_line(aes(color = Strata))) %>%
  add(geom_ribbon(alpha = 0.2)) %>%
  add(scale_color_manual(name = "", values = set1[1:2])) %>%
  add(scale_fill_manual(name = "", values = set1[1:2])) %>%
  add(guides(color = guide_legend(override.aes = list(fill = NA)))) %>%
  add(theme_trueMinimal()) %>%
  add(theme(
    legend.position = legendpos,
    legend.justification = "top")
    ) %>%
  add(labs(x = xlab, y = ylab))
}
```

> Stratification by siblings

```{r}
strat.mod4 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + 
                             + strata(siblings) + daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = c(10000, 10000),
                           data = recur,
                           hazard = "Splines")

recur.mod4 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + 
                             + siblings + daycare + siblings * daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = 10000,
                           data = recur,
                           hazard = "Splines")
```

```{r}
recur.mod4
summary(recur.mod4)
```

> Playgroup Activity

```{r}
recur.mod5 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + playgrp,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = 10000,
                           data = recur,
                           hazard = "Splines")
recur.mod5
summary(recur.mod5)
```

> Playgroup Activity + Daycare Attendance

```{r}
recur.mod6 <- frailtyPenal(Surv(t.start, t.stop, ill) ~ cluster(id) + 
                             playgrp + daycare,
                           recurrentAG = TRUE,
                           n.knots = 5,
                           kappa = 10000,
                           data = recur,
                           hazard = "Splines")
recur.mod6
summary(recur.mod6)
```

```{r}
rm(list = ls(pattern = "mod"))
detach('package:frailtypack')
detach('package:MASS')
```

## Duration of Daycare Attendance

I will use recurrent events (ARI) analysis with daycare exposure entering as a continuous covariate 

grabbing dates of ARI incidence,

```{r}

```

## Changepoint Analysis

Infants enter daycare at the - seemingly random - behest of their guardians. As methods have not been widely developed for longitudinal data with random changepoints, the idea here is to base the timing of life on the week children enter daycare, week 0, and count backward and forward from there. The interest lies on entry into daycare and the experience while in daycare, not the exit and so the data have been truncated to the end of daycare attendance.

```{r}
chng.df <- diary %>%
  filter(daycare == 1) %>%
  group_by(id) %>%
  mutate(
    first = row_number() == 1, 
    last = row_number() == n()
    ) %>%
  filter(first | last) %>%
  select(id, stdy_wk) %>%
  mutate(
    timevar = row_number(),
    timevar = ifelse(timevar == 1, "start", "finish")
    ) %>%
  ungroup() %>%
  spread(key = timevar, value = stdy_wk) %>%
  full_join(states_cov %>% mutate(id = as.character(id)), by = "id") %>%
  filter(!is.na(start) & weeks <= finish) %>%
  mutate(time = weeks - start) %>%
  select(-finish, -week, -sum, -weeks, -firstobs, -state)
``` 

The timing of the daycare attendance varies wildly...

```{r}
chng.df %>%
  distinct(id, start) %>%
  ggplot(aes(x = start)) %>%
  add(geom_histogram(color = "black")) %>%
  add(theme_trueMinimal(16)) %>%
  add(labs(
    x = "Daycare Start, Week of Infant Life",
    y = "Frequency"
  ))
```

```{r}
tmp <- chng.df %>% distinct(id, start)
psych::describe(tmp$start)
```

...ranging from 6 to 87 weeks. The mean being 31 weeks.

The approach here is to model ARI incidence using a mixed-model and making a changepoint at t = 0. Mixed-models extend to piece-wise models simply through allowing a random/varying intercept and slope at the changepoint. The model used here is a bernoulli model with a logit link for ARI incidence,

$$
y = \left\{
        \begin{array}{ll}
            1 & \quad ARI (+) \\
            0 & \quad ARI (-)
        \end{array}
    \right.
$$

The model takes this form,

$$\eta_{ij} = (\beta_0 + u_{0j}) + \beta Z_{ij} + e_{ij}\quad i=1,...,n, j = 1,...,m$$
Where each of $n$ individuals, $i$, experience $m$ time points, $j$. $u_{0j}$ denote random intercepts for each individual, $\left\{Z_{ij}\right\}_{i=1}^n$ represent any covariates of interest and $e_{ij}$ are residual errors for each individual. $\eta_{ij}$ denotes the linear predictor which is related to $Y$ (defined above) through the $logit$ link $g(E(y)) = \eta$, 

$$\log \left\{\frac{E[y]}{1-E[y]}\right\} = \eta$$

The broken-stick at $t=0$ comes in through an additional covariate,

$$\eta_{ij} = (\beta_0 + u_{0j}) + \beta Z_{ij} + \beta_cI(t \ge 0) + e_{ij}$$

Where $\beta_c$ could take the form of a random intercept or slope.

> Daycare + Start Age

```{r, fig.height = 8, fig.width = 8, message = FALSE, warning = FALSE}
library(brms)
library(rstan)
theme_set(theme_trueMinimal())

# brmmod1 <- brm(ill ~ time:daycare + start + (1 | id),
#                prior = c(set_prior ("normal (0, 5)", class = "b")),
#                data = chng.df,
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod1, "brm_dc_start.rds")
brmmod1 <- readRDS("brm_dc_start.rds")

plot(brmmod1)
```

All chains mix well and parameters are identifiable

```{r}
summary(brmmod1)
exp(fixef(brmmod1))
```

```{r}
pp_check(brmmod1)
```

Posterior predictive check shows a well fitting model

```{r}
plot(marginal_effects(brmmod1), points = TRUE, newpage = FALSE, ask = FALSE)
```

The second plot doesn't make much sense as daycare attendance before time = 0 cannot happen, by definition.

```{r, eval = TRUE, echo = FALSE}
# function to plot predictions from (g)lmm models with 1 changepoint
#' @param pframe data frame of 
#' @param df optional data frame of group-wise trajectories, for spaghetti plots
#' @param x character string for variable in pframe and df where x is the independent axis in the plot
#' @param y character string for variable in pframe and df where y is the dependent axis in the plot
#' @param group optional, describes cluster in df for spaghetti plots
#' @param xlab character string x-axis label
#' @param ylab character string y-axis label

predChngPlot <- function(pframe,
                         df = NULL,
                         x, y,
                         group = NULL,
                         xlab = "Standardized Study Time (weeks)",
                         ylab = "Probability of ARI") {
  
  set1 <- RColorBrewer::brewer.pal(9, "Set1")
  p <- pframe %>%
    ggplot(aes(x = .[, x], y = .[, y])) %>%
    add(geom_line(color = set1[1])) %>%
    add(geom_vline(xintercept = 0, lty = 2)) %>%
    add(theme_trueMinimal(16)) %>%
    add(labs(x = xlab, y = ylab))
  
  if (!is.null(df)) {
    p <- p + geom_line(data = df, 
                       aes(x = df[, x], 
                           y = df[, y], 
                           group = df[, group]),
                       alpha = 0.1)
  }
  p
}
```

```{r}
pframe <- data.frame(
  time = seq(-86, 91, by = 1),
  start = mean(chng.df$start)
  )

pframe <- transform(pframe, daycare = factor(ifelse(time >= 0, 1, 0)))

prediction <- data.frame(
  predict(brmmod1, 
          newdata = pframe,
          re_formula = NA)
  )

pframe <- cbind(pframe, prediction)

colnames(pframe) <- c("time", "start", "daycare", "ill", "SE", "LB", "UB")

p1 <- predChngPlot(pframe, chng.df, "time", "ill", "id")
p1
```

The red-line is the prediction from the model, with a changepoint at 0 for time of daycare entrance.

```{r}
p2 <- predChngPlot(pframe = pframe, x = "time", y = "ill")
p2
```

> Daycare + Start Age + Sex

```{r, warning = FALSE, message = FALSE}
# brmmod2 <- brm(ill ~ time:daycare + start + female + (1 | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod2, "brm_dc_start_sex.rds")
brmmod2 <- readRDS("brm_dc_start_sex.rds")

summary(brmmod2)
exp(fixef(brmmod2))
```

```{r, echo = FALSE, eval = TRUE}
# function to extract model predictions from model of class 'brmsfit',
# specific to this project
#' @param conditions data.frame of conditions for prediction, correspond to features/covariates of model parameter
#' @param model of class 'brmsfit'
extractPred <- function(conditions, model) {
  predicted <- marginal_effects(model, conditions = conditions)
  predicted.df <- predicted$`time:daycare` %>% 
    filter(daycare == 1 & time >= 0 | daycare == 0 & time <= 0) %>%
    select(-ill, -id, -cond__)
  colnames(predicted.df) <- gsub("__", "", colnames(predicted.df))
  predicted.df
}

# function to plot group predictions from model of class 'brmsfit'
#' @param df data.frame formatted output from brms::prediction()
#' @param group character string corresponding to a factor covariate in call to brms::brm
#' @param labels factor labels for group parameter
#' @param set color set (e.g. RColorBrewer(9, "Set1"))
#' @param legend.pos vector of type 'num' describing relative coordinates of legend position
#' @param conf.band plot credible intervals/confidence bands?
predGrpPlot <- function(df,
                        group,
                        labels,
                        set,
                        legend.pos = c(0.1, 0.85),
                        conf.band = FALSE) {
  
  df[, group] <- factor(df[, group], 0:1, labels)
  
  p <- df %>%
    ggplot(aes(x = time, y = estimate, color = .[, group])) %>%
    add(geom_line()) %>%
    add(geom_vline(xintercept = 0, lty = 2)) %>%
    add(theme_trueMinimal(16)) %>%
    add(theme(legend.position = legend.pos)) %>%
    add(scale_color_manual(values = c(set[1], set[2]))) %>%
    add(labs(
      x = "Time (weeks)",
      y = "Probability of ARI",
      color = ""
    ))
  
  if (conf.band) {
    p <- p + geom_ribbon(aes(ymin = lower, ymax = upper, fill = df[, group]),
                         alpha = 0.3,
                         show.legend = FALSE,
                         color = NA)
    p <- p + scale_fill_manual(values = c(set[1], set[2]))
  }
  p
}
```

```{r}
set1 <- RColorBrewer::brewer.pal(9, "Set1")

conditions <- data.frame(female = c(0, 1))

predicted.female <- extractPred(conditions, brmmod2)

p3 <- predGrpPlot(predicted.female, 
                  "female",
                  c("Male", "Female"), 
                  set1,
                  conf.band = TRUE)
p3
```

> Daycare + Start Age + siblings

```{r, warning = FALSE, message = FALSE}
# brmmod3 <- brm(ill ~ time:daycare + start + siblings + (1 | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod3, "brm_dc_start_sibs.rds")
brmmod3 <- readRDS("brm_dc_start_sibs.rds")

summary(brmmod3)
exp(fixef(brmmod3))
```

```{r}
conditions <- data.frame(siblings = c(0, 1))

predicted.sibs <- extractPred(conditions, brmmod3)

p4 <- predGrpPlot(predicted.sibs, 
                  "siblings", 
                  c("No Siblings", "Siblings"), 
                  set1, 
                  conf.band = TRUE)
p4
```

> Daycare + Start Age + HBoV-1 carry

```{r, warning = FALSE, message = FALSE}
# brmmod4 <- brm(ill ~ time:daycare + start + hbov.pos + (1 | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod4, "brm_dc_start_boca.rds")
brmmod4 <- readRDS("brm_dc_start_boca.rds")

summary(brmmod4)
exp(fixef(brmmod4))
```

```{r}
conditions <- data.frame(hbov.pos = c(0, 1))

predicted.boca <- extractPred(conditions, brmmod4)

p5 <- predGrpPlot(predicted.boca, 
                  "hbov.pos", 
                  c("HBoV-1 (-)", "HBoV-1 (+)"), 
                  set1, 
                  conf.band = TRUE)
p5
```

> Daycare + Start Age + Play Group Activity

```{r, warning = FALSE, message = FALSE}
# brmmod5 <- brm(ill ~ time:daycare + start + playgrp + (1 | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod5, "brm_dc_start_pg.rds")
brmmod5 <- readRDS("brm_dc_start_pg.rds")

summary(brmmod5)
exp(fixef(brmmod5))
```

```{r}
conditions <- data.frame(playgrp = c(0, 1))

predicted.pg <- extractPred(conditions, brmmod5)

p6 <- predGrpPlot(predicted.pg, 
                  "playgrp", 
                  c("No Play Group", "Play Group"), 
                  set1,
                  legend.pos = c(0.15, 0.85),
                  conf.band = TRUE)
p6
```

> Daycare + Start Age + Random Slope

```{r, warning = FALSE, message = FALSE}
# brmmod6 <- brm(ill ~ time:daycare + start + (1 + time | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod6, "brm_dc_start_ranslope.rds")
brmmod6 <- readRDS("brm_dc_start_ranslope.rds")

summary(brmmod6)
exp(fixef(brmmod6))
```

```{r}
WAIC(brmmod1, brmmod6, compare = TRUE)
```

Random intercept and slope is a better fit than random slope alone

```{r}
pframe <- data.frame(
  time = seq(-86, 91, by = 1),
  start = mean(chng.df$start)
  )

pframe <- transform(pframe, daycare = factor(ifelse(time >= 0, 1, 0)))

prediction <- data.frame(
  predict(brmmod6, 
          newdata = pframe,
          re_formula = NA)
  )

pframe <- cbind(pframe, prediction)

colnames(pframe) <- c("time", "start", "daycare", "ill", "SE", "LB", "UB")

p7 <- predChngPlot(pframe, chng.df, "time", "ill", "id")
p7
```

```{r}
p8 <- predChngPlot(pframe, x = "time", y = "ill")
p8
```

> Daycare + Start Age + Sex + Random Slope

```{r, warning = FALSE, message = FALSE}
# brmmod7 <- brm(ill ~ time:daycare + start + female + (1 + time | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod7, "brm_dc_start_sex_rans.rds")
brmmod7 <- readRDS("brm_dc_start_sex_rans.rds")

summary(brmmod7)
exp(fixef(brmmod7))
```

```{r}
conditions <- data.frame(female = c(0, 1))

predicted.female.ransl <- extractPred(conditions, brmmod7)

p9 <- predGrpPlot(predicted.female.ransl, 
                  "female", 
                  c("Male", "Female"), 
                  set1,
                  legend.pos = c(0.15, 0.85),
                  conf.band = TRUE)
p9
```

> Daycare + Start Age + Siblings + Random Slope

```{r, warning = FALSE, message = FALSE}
# brmmod8 <- brm(ill ~ time:daycare + start + siblings + (1 + time | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod8, "brm_dc_start_sibs_rans.rds")
brmmod8 <- readRDS("brm_dc_start_sibs_rans.rds")

summary(brmmod8)
exp(fixef(brmmod8))
```

```{r}
conditions <- data.frame(siblings = c(0, 1))

predicted.sibs.ransl <- extractPred(conditions, brmmod8)

p10 <- predGrpPlot(predicted.sibs.ransl, 
                   "siblings", 
                   c("No Siblings", "Siblings"), 
                   set1,
                   legend.pos = c(0.15, 0.85),
                   conf.band = TRUE)
p10
```

> Daycare + Start Age + HBoV-1 carry + Random Slopes

```{r, warning = FALSE, message = FALSE}
# brmmod9 <- brm(ill ~ time:daycare + start + hbov.pos + (1 + time | id),
#                prior = c(prior(student_t(5, 0, 10), class = "b"),
#                          prior(cauchy(0, 2), class = "sd")),
#                data = chng.df,
#                family = bernoulli,
#                cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod9, "brm_dc_start_boca_rans.rds")
brmmod9 <- readRDS("brm_dc_start_boca_rans.rds")

summary(brmmod9)
exp(fixef(brmmod9))
```

```{r}
conditions <- data.frame(hbov.pos = c(0, 1))

predicted.boca.ransl <- extractPred(conditions, brmmod9)

p11 <- predGrpPlot(predicted.boca.ransl, 
            "hbov.pos", 
            c("HBoV-1 (-)", "HBoV-1 (+)"), 
            set1,
            legend.pos = c(0.15, 0.85),
            conf.band = TRUE)
p11
```

> Daycare + Start Age + Play Group Activity

```{r, warning = FALSE, message = FALSE}
# brmmod10 <- brm(ill ~ time:daycare + start + playgrp + (1 | id),
#                 prior = c(prior(student_t(5, 0, 10), class = "b"),
#                           prior(cauchy(0, 2), class = "sd")),
#                 data = chng.df,
#                 family = bernoulli,
#                 cores = 4)

setwd("Rdata/output")
# setwd("~/Documents/Martin Lab/HBov-1/illness_burden_dc/Rdata/output")
# saveRDS(brmmod10, "brm_dc_start_pg_rans.rds")
brmmod10 <- readRDS("brm_dc_start_pg_rans.rds")

summary(brmmod10)
exp(fixef(brmmod10))
```

```{r}
conditions <- data.frame(playgrp = c(0, 1))

predicted.pg.ransl <- extractPred(conditions, brmmod10)

p12 <- predGrpPlot(predicted.pg.ransl,
                   "playgrp",
                   c("No Play Group", "Play Group"),
                   set1,
                   legend.pos = c(0.15, 0.85),
                   conf.band = TRUE)
p12
```

Put plots together for publication figure

```{r}
library(cowplot)
library(grid)
library(gridExtra)
setwd("..")

plotlist <- list(p9, p10, p11, p12)
for(i in 1:length(plotlist)) {
  plotlist[[i]] <- plotlist[[i]] + labs(x = "", y = "")
}

bottom <- plot_grid(plotlist[[1]],
                    plotlist[[2]],
                    plotlist[[3]],
                    plotlist[[4]],
                    nrow = 2,
                    labels = LETTERS[2:5])
g <- plot_grid(p8, bottom, 
               ncol = 1, 
               labels = c('A', ''), 
               rel_heights = c(1, 2.5))
g
```

```{r, eval = FALSE, echo = FALSE}
# ggsave("plots/chngpt_plot.tiff", g,
#        height = 16, width = 12, units = "in",
#        dpi = 1200,
#        compression = "lzw")
```

# Misc. Functons

```{r, echo = TRUE, eval = FALSE}
# true minimal theme for plotting ggplot objects
theme_trueMinimal <- function(base_size = 16, base_family = "") {
    theme_bw(base_size = base_size, base_family = base_family) %+replace% 
        theme(axis.ticks = element_blank(), 
              legend.background = element_blank(), 
              legend.key = element_blank(), 
              panel.background = element_blank(), 
              strip.background = element_blank(), 
              panel.border = element_blank(),
              panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              plot.background = element_blank(), 
              axis.line = element_line(), 
              axis.line.y = element_blank(),
              complete = TRUE)
}

# function to simulate predictions from msm::pmatrix.msm
#' @param object of class 'msm' from msm package
#' @param time integer, time interval to estimate transition probabilities
#' @param levels factor levels for transitions in markov model
#' @param labels factor labels for transitions in markov model
#' @param covariates list of covariate values at which to estimate the transition probabilities

pmat_sim <- function(model,
                     time,
                     levels = NULL, 
                     labels = NULL,
                     covariates = NULL) {
  require(dplyr)
  df_list <- list()
  for (i in 1:time) {
    if (is.null(covariates)) {
      pmat <- pmatrix.msm(model, 
                          ci = "normal", 
                          t = i, 
                          cl = 0.95)
    } else {
      pmat <- pmatrix.msm(model, 
                          ci = "normal", 
                          t = i, 
                          cl = 0.95,
                          covariates = covariates)
    }
    estimates <- as.data.frame(as.table(pmat$estimates))
    colnames(estimates) <- c("From", "To", "P_rs")
    UB <- as.data.frame(as.table(pmat$U))
    LB <- as.data.frame(as.table(pmat$L))
    estimates$UB <- UB$Freq
    estimates$LB <- LB$Freq
    estimates$time <- as.numeric(i)
    df_list[[i]] <- estimates
  } # end for
  df <- bind_rows(df_list)
  if (!is.null(levels)) {
    df <- df %>% 
      mutate(
        transition = paste(From, To, sep = " - "),
        transition = factor(transition,
                            levels = levels,
                            labels = labels)
      ) %>%
      select(-From, -To)
  } # end if
  df
}

# function to plot predictions from (g)lmm models with 1 changepoint
#' @param pframe data frame of 
#' @param df optional data frame of group-wise trajectories, for spaghetti plots
#' @param x character string for variable in pframe and df where x is the independent axis in the plot
#' @param y character string for variable in pframe and df where y is the dependent axis in the plot
#' @param group optional, describes cluster in df for spaghetti plots

predChngPlot <- function(pframe,
                         df = NULL, 
                         x, y, 
                         group = NULL) {
  
  set1 <- RColorBrewer::brewer.pal(9, "Set1")
  p <- pframe %>%
    ggplot(aes(x = .[, x], y = .[, y])) %>%
    add(geom_line(color = set1[1])) %>%
    add(geom_vline(xintercept = 0, lty = 2)) %>%
    add(theme_trueMinimal(16)) %>%
    add(labs(
      x = "Standardized Study Times, Weeks",
      y = "Probability of ARI"
    ))
  
  if (!is.null(df)) {
    p <- p + geom_line(data = df, 
                       aes(x = df[, x], 
                           y = df[, y], 
                           group = df[, group]),
                       alpha = 0.1)
  }
  p
}

# function to extract survival probabilities from frailtyPenal() fit objects
# with stratified variables
#' @param fit Object of class frailtyPenal with or without stratified covariate, strata()
#' @param strata character vector of strata names, default is NULL
#' @value object of class data.frame() with columns Strata, Surv (survival probability), LB (95% CI lower bound), UB (95% CI upper bound)

extractStrataFit <- function(fit, strata = NULL) {
  header <- c("Surv", "LB", "UB", "Strata", "Time")
  if (!is.null(strata)) {
    strata1 <- as.data.frame(fit$surv[, , 1])
    strata1$strata <- strata[1]
    strata1$time <- as.numeric(rownames(strata1))
    
    strata2 <- as.data.frame(fit$surv[, , 2])
    strata2$strata <- strata[2]
    strata2$time <- as.numeric(rownames(strata2))
    
    df <- data.frame(rbind(strata1, strata2))
    colnames(df) <- header
    return(df)
  } else {
    df <- data.frame(fit$surv[, , 1])
    df$time <- as.numeric(rownames(df))
    colnames(df) <- header[c(1:3, 5)]
    return(df)
  }
}

# function to plot survival curves extracted from frailtyPenal class objects
#' @param fit Object of class frailtyPenal with or without stratified covariate, strata()
#' @param strata character vector of strata names, default is NULL
#' @param xlab x-axis label, default is empty string ("")
#' @param ylab y-axis label, default is empty string ("")
#' @param legendpos numeric vector of length 2, acceptable values between 0, 1

plotStratSurv <- function(fit,
                          strata,
                          xlab = "",
                          ylab = "",
                          legendpos = c(0.8, 0.8)) {
  extractStrataFit(fit, strata) %>%
  ggplot(aes(x = Time, y = Surv, ymin = LB, ymax = UB, fill = Strata)) %>%
  add(geom_line(aes(color = Strata))) %>%
  add(geom_ribbon(alpha = 0.2)) %>%
  add(scale_color_manual(name = "", values = set1[1:2])) %>%
  add(scale_fill_manual(name = "", values = set1[1:2])) %>%
  add(guides(color = guide_legend(override.aes = list(fill = NA)))) %>%
  add(theme_trueMinimal()) %>%
  add(theme(
    legend.position = legendpos,
    legend.justification = "top")
    ) %>%
  add(labs(x = xlab, y = ylab))
}

# function to extract model predictions from model of class 'brmsfit',
# specific to this project
#' @param conditions data.frame of conditions for prediction, correspond to features/covariates of model parameter
#' @param model of class 'brmsfit'

extractPred <- function(conditions, model) {
  predicted <- marginal_effects(model, conditions = conditions)
  predicted.df <- predicted$`time:daycare` %>% 
    filter(daycare == 1 & time >= 0 | daycare == 0 & time <= 0) %>%
    select(-ill, -id, -cond__)
  colnames(predicted.df) <- gsub("__", "", colnames(predicted.df))
  predicted.df
}

# function to plot group predictions from model of class 'brmsfit'
#' @param df data.frame formatted output from brms::prediction()
#' @param group character string corresponding to a factor covariate in call to brms::brm
#' @param labels factor labels for group parameter
#' @param set color set (e.g. RColorBrewer(9, "Set1"))
#' @param legend.pos vector of type 'num' describing relative coordinates of legend position
#' @param conf.band plot credible intervals/confidence bands?

predGrpPlot <- function(df,
                        group,
                        labels,
                        set,
                        legend.pos = c(0.1, 0.85),
                        conf.band = FALSE) {
  
  df[, group] <- factor(df[, group], 0:1, labels)
  
  p <- df %>%
    ggplot(aes(x = time, y = estimate, color = .[, group])) %>%
    add(geom_line()) %>%
    add(geom_vline(xintercept = 0, lty = 2)) %>%
    add(theme_trueMinimal(16)) %>%
    add(theme(legend.position = legend.pos)) %>%
    add(scale_color_manual(values = c(set[1], set[2]))) %>%
    add(labs(
      x = "Time, weeks",
      y = "Probability of ARI",
      color = ""
    ))
  
  if (conf.band) {
    p <- p + geom_ribbon(aes(ymin = lower, ymax = upper, fill = df[, group]),
                         alpha = 0.3,
                         show.legend = FALSE,
                         color = NA)
    p <- p + scale_fill_manual(values = c(set[1], set[2]))
  }
  p
}

# function to perform bootstrap estimation on sojourn difference estimates
# requires libraries msm, dplyr
# cluster should be called 'id', for now...msm issue
#' @param formula, object of class 'formula' for use in msm::msm(covariates = ,)
#' @param data, data.frame for msm::msm()
#' @param B boostrap replicates
#' @param pergrp number of groups per bootstrap replicate
#' @param grp, charcter string describing subjects in data parameter
#' @param difflist object of type 'list' to pass to msm::sojourn.msm(covariates = ,)
#' @param Q object of type 'matrix', initial/crude matrix for setting up Q tranisiton matrix in msm::msm()
#' @param censor indicator in data$states denoting censored observations/states

bootSojourn <- function(formula,
                        data,
                        B = 100,
                        cluster,
                        difflist,
                        qmatrix,
                        censor) {
  
  sojourn_diff <- matrix(NA, nrow = B, ncol = 1)
  
  pb <- txtProgressBar(min = 1, max = B, style = 3)
  for (i in 1:B) {
    
    data[, cluster] <- as.factor(data[, cluster])
    
    clust_samp <- sample(levels(data[[cluster]]), replace = TRUE)
    
    samp <- data[data[[cluster]] %in% clust_samp, ]
    
    markov <- msm(state ~ weeks,
                  subject = id,
                  covariates = formula,
                  censor = censor,
                  data = samp,
                  qmatrix = qmatrix,
                  gen.inits = TRUE)
    
    sojourn0 <- sojourn.msm(markov, covariates = difflist[[1]])
    sojourn1 <- sojourn.msm(markov, covariates = difflist[[2]])
    
    sojourn_diff[i, 1] <- sojourn1[2, 1] - sojourn0[2, 1]
    
    setTxtProgressBar(pb, i)
  }
  
  result <- data.frame(result = rep(NA, 2))
  row.names(result) <- c("Mean (SD):", "Median (95% CI):")
  
  result[1, ] <- paste0(round(mean(sojourn_diff), 2), 
                        " (",
                        round(sd(sojourn_diff), 2),
                        ")")
  
  result[2, ] <- paste0(round(quantile(sojourn_diff, 0.5), 2),
                        " (",
                        round(quantile(sojourn_diff, 0.025), 2),
                        ", ",
                        round(quantile(sojourn_diff, 0.975), 2),
                        ")")
  
  list(sojourn_diff = sojourn_diff, results = result)
}
```

# References
